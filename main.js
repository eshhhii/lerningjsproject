(()=>{"use strict";class e{constructor(e,t,s,r,n){let{handleCardClick:i,handleCardLike:o,handleCardDelete:a}=r;this._title=e.name,this._link=e.link,this._ownerId=e.owner._id,this._likeCard=e.likes,this._userId=t,this._card=s,this._handleCardClick=i,this._handleCardLike=o,this._handleCardDelete=a,this._id=n,this._element=this._getTemplate(),this._imageCard=this._element.querySelector(".element__image"),this._like=this._element.querySelector(".element__like"),this._likeCounter=this._element.querySelector(".element__counter"),this._bin=this._element.querySelector(".element__bin")}_getTemplate(){return this._card.content.querySelector(".element").cloneNode(!0)}generateCard(){return this._element.querySelector(".element__title").textContent=this._title,this._imageCard.src=this._link,this._imageCard.alt=this._title,this._ownerId!==this._userId&&this._bin.remove(),this.setEventListeners(),this.rendererLikes(),this._element}setEventListeners(){this._bin.addEventListener("click",(()=>{this._handleCardDelete()})),this._like.addEventListener("click",(()=>{this._handleCardLike()})),this._imageCard.addEventListener("click",(()=>{this._handleCardClick()}))}getId(){return this._id}isLiked(){return this._likeCard.some((e=>e._id===this._userId))}rendererLikes(){this._likeCounter.textContent=this._likeCard.length,this.changeLikes(this._userId)}changeLikes(){this.isLiked(this._userId)?this._like.classList.add("element__like_active"):this._like.classList.remove("element__like_active")}setLikes(e){this._likeCard=e}removeCard(){this._bin.closest(".element").remove()}}class t{constructor(e,t){this._input=e.inputSelector,this._submitButton=e.submitButtonSelector,this._inactiveButtonClass=e.inactiveButtonClass,this._inputErrorClass=e.inputErrorClass,this._errorClass=e.errorClass,this._formElement=t}_allInputsEmpty(){return!this._inputList.some((e=>e.value.length>0))}_hasInvalidInput(){return this._inputList.some((e=>!e.validity.valid))}_showInputError(e){this._errorElement=this._formElement.querySelector("#".concat(e.id,"-error")),e.classList.add(this._inputErrorClass),this._errorElement.textContent=e.validationMessage,this._errorElement.classList.add(this._errorClass)}_hideInputError(e){this._errorElement=this._formElement.querySelector("#".concat(e.id,"-error")),e.classList.remove(this._inputErrorClass),this._errorElement.classList.remove(this._errorClass)}_checkInput(e){e.validity.valid?this._hideInputError(e):this._showInputError(e)}_toggleButtonState(){this._hasInvalidInput(this._inputList)||this._allInputsEmpty(this._inputList)?(this._buttonElement.classList.add(this._inactiveButtonClass),this._buttonElement.setAttribute("disabled",!0)):(this._buttonElement.classList.remove(this._inactiveButtonClass),this._buttonElement.removeAttribute("disabled"))}removeFormErrorContainer(){this._formElement.querySelectorAll(".popup__error").forEach((e=>{e.classList.remove(this._errorClass)})),this._formElement.querySelectorAll(this._input).forEach((e=>{e.classList.remove(this._inputErrorClass)}))}disableSubmitButton(){this._formElement.querySelector(this._submitButton).classList.add(this._inactiveButtonClass)}_setInputListeners(){this._inputList=Array.from(this._formElement.querySelectorAll(this._input)),this._buttonElement=this._formElement.querySelector(this._submitButton),this._inputList.forEach((e=>{e.addEventListener("input",(()=>{this._checkInput(e),this._toggleButtonState()}))}))}enableValidation(){this._formElement.addEventListener("submit",(e=>{e.preventDefault()})),this._setInputListeners()}}class s{constructor(e){this._popup=document.querySelector(e),this._handleEscClose=this._handleEscClose.bind(this),this._handleOverlayClose=this._handleOverlayClose.bind(this)}open(){this._popup.classList.add("popup_opened"),document.addEventListener("keydown",this._handleEscClose)}close(){this._popup.classList.remove("popup_opened"),document.removeEventListener("keydown",this._handleEscClose)}_handleEscClose(e){"Escape"===e.key&&this.close()}_handleOverlayClose(){this._popup.addEventListener("click",(()=>{this.close()})),this._popup.querySelector(".popup__container").addEventListener("click",(function(e){e.stopPropagation()}))}setEventListeners(){this._popup.querySelector(".popup__close").addEventListener("click",(()=>{this.close()})),this._handleOverlayClose()}}class r extends s{constructor(e,t){super(e),this._handleFormSubmit=t,this._popupForm=this._popup.querySelector(".popup__form"),this._inputList=this._popupForm.querySelectorAll(".popup__input"),this._saveButton=this._popupForm.querySelector(".popup__save"),this._defaultSaveButtonText=this._saveButton.textContent}_getInputValues(){return this._newValues={},this._inputList.forEach((e=>{this._newValues[e.name]=e.value})),this._newValues}setEventListeners(){this._popupForm.addEventListener("submit",(e=>{e.preventDefault(),this._handleFormSubmit(this._getInputValues())})),super.setEventListeners()}rendererLoading(e){this._saveButton.textContent=e?"Cохранение...":this._defaultSaveButtonText}close(){super.close(),this._popupForm.reset()}}const n=document.querySelector(".template"),i=document.querySelector(".profile__edit"),o=(document.querySelector(".popup__close"),document.querySelector(".profile__add")),a=document.querySelector(".profile__container"),l=document.querySelector("#username"),h=document.querySelector("#userjob"),c=document.querySelector(".popup__form"),u=document.querySelector("#popupFormAdd"),d=document.querySelector("#popupFormAvatar"),_={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__save",inactiveButtonClass:"popup__save_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"};let p;const m=new class{constructor(e){this._url=e.url,this._headers=e.headers}getAllData(){return Promise.all([this.getUserInfo(),this.getInitialCards()])}getInitialCards(){return fetch("".concat(this._url,"/cards"),{method:"GET",headers:this._headers}).then((e=>e.ok?e.json():Promise.reject("Ошибка! ".concat(e.status))))}getUserInfo(){return fetch("".concat(this._url,"/users/me"),{method:"GET",headers:this._headers}).then((e=>e.ok?e.json():Promise.reject("Ошибка! ".concat(e.status))))}editUserInfo(e,t){return fetch("".concat(this._url,"/users/me"),{method:"PATCH",headers:this._headers,body:JSON.stringify({name:e,about:t})}).then((e=>e.ok?e.json():Promise.reject("Ошибка! ".concat(e.status))))}editUserAvatar(e){return fetch("".concat(this._url,"/users/me/avatar"),{method:"PATCH",headers:this._headers,body:JSON.stringify({avatar:e})}).then((e=>e.ok?e.json():Promise.reject("Ошибка! ".concat(e.status))))}addCard(e,t){return fetch("".concat(this._url,"/cards"),{method:"POST",headers:this._headers,body:JSON.stringify({name:e,link:t})}).then((e=>e.ok?e.json():Promise.reject("Ошибка! ".concat(e.status))))}deleteCard(e){return fetch("".concat(this._url,"/cards/").concat(e),{method:"DELETE",headers:this._headers}).then((e=>e.ok?e.json():Promise.reject("Ошибка! ".concat(e.status))))}likeCard(e){return fetch("".concat(this._url,"/cards/likes/").concat(e),{method:"PUT",headers:this._headers}).then((e=>e.ok?e.json():Promise.reject("Ошибка! ".concat(e.status))))}deleteLike(e){return fetch("".concat(this._url,"/cards/likes/").concat(e),{method:"DELETE",headers:this._headers}).then((e=>e.ok?e.json():Promise.reject("Ошибка! ".concat(e.status))))}}({url:"https://mesto.nomoreparties.co/v1/cohort-24",headers:{authorization:"a37e79bf-5aa8-4ffb-8375-5c9e4f6d74df","content-type":"application/json"}});function v(t,s,r){const n=new e(t,s,r,{handleCardClick:()=>{E.open(t.name,t.link)},handleCardLike:()=>{(n.isLiked()?m.deleteLike(n.getId()):m.likeCard(n.getId())).then((e=>{n.setLikes(e.likes),n.rendererLikes()})).catch((e=>{console.log(e)}))},handleCardDelete:()=>{b.open(n)}},t._id);return n}const C=new class{constructor(e,t){let{renderer:s}=e;this._renderer=s,this._container=document.querySelector(t)}addItem(e,t){const s=t?"append":"prepend";this._container[s](e)}renderItems(e){e.forEach((e=>{this._renderer(e)}))}}({renderer:e=>{const t=v(e,p,n).generateCard();C.addItem(t,!0)}},".elements__list"),E=new class extends s{constructor(e){super(e),this._popupImageName=this._popup.querySelector(".popup__title_image")}open(e,t){this._popupImageName.textContent=e,this._popup.querySelector(".popup__image").src=t,this._popupImageName.alt=e,super.open()}}(".popup_images");E.setEventListeners();const L=new class{constructor(e,t,s){this._userName=document.querySelector(e),this._userJob=document.querySelector(t),this._avatar=document.querySelector(s)}getUserInfo(){return{name:this._userName.textContent,about:this._userJob.textContent}}setUserInfo(e,t){this._userName.textContent=e,this._userJob.textContent=t}setAvatar(e){this._avatar.src=e,this._avatar.alt=this._userName.textContent}}(".profile__name",".profile__job",".profile__avatar"),k=new r(".popup_edit",(e=>{k.rendererLoading(!0),m.editUserInfo(e.name,e.about).then((()=>{L.setUserInfo(e.name,e.about),k.close()})).finally((()=>{k.rendererLoading(!1)})).catch((e=>{console.log(e)}))}));k.setEventListeners();const f=new r(".popup_add",(e=>{f.rendererLoading(!0),m.addCard(e.name,e.link).then((e=>{const t=v(e,p,n).generateCard();C.addItem(t),f.close()})).finally((()=>{f.rendererLoading(!1)})).catch((e=>{console.log(e)}))}));f.setEventListeners();const y=new r(".popup_update",(e=>{y.rendererLoading(!0),m.editUserAvatar(e["link-avatar"]).then((()=>{L.setAvatar(e["link-avatar"]),y.close()})).finally((()=>{y.rendererLoading(!1)})).catch((e=>{console.log(e)}))}));y.setEventListeners();const b=new class extends s{constructor(e,t){super(e),this._handleSubmitCallback=t,this._popupForm=this._popup.querySelector(".popup__form")}setEventListeners(){this._popupForm.addEventListener("submit",(e=>{e.preventDefault(),this._handleSubmitCallback(this._card)})),super.setEventListeners()}open(e){this._card=e,super.open()}}(".popup_delete",(e=>{m.deleteCard(e.getId()).then((()=>{e.removeCard(),b.close()})).catch((e=>{console.log(e)}))}));b.setEventListeners(),m.getAllData().then((e=>{const[t,s]=e;L.setUserInfo(t.name,t.about),L.setAvatar(t.avatar),p=t._id,C.renderItems(s)})).catch((e=>{console.log(e)})),o.addEventListener("click",(()=>{S.removeFormErrorContainer(),S.disableSubmitButton(),f.open()})),i.addEventListener("click",(()=>{const e=L.getUserInfo();l.value=e.name,h.value=e.about,g.removeFormErrorContainer(),k.open()})),a.addEventListener("click",(()=>{I.removeFormErrorContainer(),I.disableSubmitButton(),y.open()}));const g=new t(_,c);g.enableValidation();const S=new t(_,u);S.enableValidation();const I=new t(_,d);I.enableValidation()})();